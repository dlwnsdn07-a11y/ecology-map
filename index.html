<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>서울교육대학교 생태지도 3D</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>

<style>
  *{box-sizing:border-box;}
  html,body{margin:0;height:100%;font-family:-apple-system, BlinkMacSystemFont,"Noto Sans KR",sans-serif;}
  #map{width:100%;height:100%;}

  .marker{
    width:34px;height:34px;border-radius:50%;
    background:#fff;border:2px solid #222;display:flex;align-items:center;justify-content:center;
    font-size:20px;box-shadow:0 2px 6px rgba(0,0,0,.2);cursor:pointer;
  }
  .marker.tree{border-color:#2e7d32}
  .marker.conifer{border-color:#1b5e20}
  .marker.shrub{border-color:#558b2f}
  .marker.flower{border-color:#c2185b}
  .marker.herb{border-color:#6a1b9a}
  .marker.grass{border-color:#00796b}
  .marker.vine{border-color:#2e7d32}
  .marker.insect{border-color:#f57c00}
  .marker.spider{border-color:#6d4c41}
  .marker.animal{border-color:#455a64}

  .popup{max-width:320px;font-size:14px;line-height:1.55;}
  .popup h3{margin:0 0 6px;font-size:16px;}
  .popup img{width:100%;border-radius:8px;margin:6px 0;}
  .popup .tags span{
    display:inline-block;padding:2px 6px;border:1px solid #ddd;border-radius:999px;
    font-size:12px;margin-right:4px;margin-top:4px;background:#f7f7f7;
  }

  .legend{
    position:absolute;left:10px;top:10px;z-index:50;
    background:#fff;border:1px solid #ccc;border-radius:10px;padding:10px 12px;font-size:13px;
    box-shadow:0 2px 8px rgba(0,0,0,.15);
  }
  .legend-row{display:flex;align-items:center;gap:6px;margin:4px 0;}
  .legend .dot{
    width:20px;height:20px;border-radius:50%;border:2px solid #222;
    display:flex;align-items:center;justify-content:center;font-size:14px;
  }
  .dot.tree{border-color:#2e7d32}.dot.conifer{border-color:#1b5e20}.dot.shrub{border-color:#558b2f}
  .dot.flower{border-color:#c2185b}.dot.herb{border-color:#6a1b9a}.dot.grass{border-color:#00796b}
  .dot.vine{border-color:#2e7d32}.dot.insect{border-color:#f57c00}.dot.spider{border-color:#6d4c41}.dot.animal{border-color:#455a64}
</style>
</head>
<body>

<div id="map"></div>

<div class="legend">
  <div class="legend-row"><span class="dot conifer">🌲</span> 침엽수</div>
  <div class="legend-row"><span class="dot tree">🌳</span> 활엽 교목</div>
  <div class="legend-row"><span class="dot shrub">🌿</span> 관목</div>
  <div class="legend-row"><span class="dot flower">🌸</span> 꽃/화목</div>
  <div class="legend-row"><span class="dot herb">🪴</span> 초본</div>
  <div class="legend-row"><span class="dot grass">🌾</span> 잔디/벼과</div>
  <div class="legend-row"><span class="dot vine">🧵</span> 덩굴</div>
  <div class="legend-row"><span class="dot insect">🐛</span> 곤충</div>
  <div class="legend-row"><span class="dot spider">🕷️</span> 거미</div>
  <div class="legend-row"><span class="dot animal">🐱</span> 동물</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoianVudXV1dSIsImEiOiJjbWg1OXI2enEwNXJiMmlyM2txdHBjNmNwIn0.HdqWmsUAAzUdtbIOmHoSvg';

const map = new mapboxgl.Map({
  container:'map',
  style:'mapbox://styles/mapbox/light-v11',
  center:[127.0160,37.4899],
  zoom:18,
  pitch:60,
  bearing:-20
});

map.on('style.load',()=>{
  const labelLayer = map.getStyle().layers.find(l=>l.type==='symbol' && l.layout?.["text-field"]);
  map.addLayer({
    id:'3d-buildings',
    source:'composite',
    'source-layer':'building',
    filter:['==','extrude','true'],
    type:'fill-extrusion',
    minzoom:15,
    paint:{
      'fill-extrusion-color':'#a7b0b5',
      'fill-extrusion-height':['interpolate',['linear'],['zoom'],15,0,15.05,['get','height']],
      'fill-extrusion-base':['interpolate',['linear'],['zoom'],15,0,15.05,['get','min_height']],
      'fill-extrusion-opacity':0.7
    }
  },labelLayer?.id);
});

map.on('click',e=>console.log('clicked:',e.lngLat));

// 여기까지 PART1
// ===== 여기서부터 PART2 (데이터 + 마커 렌더링 준비) =====

// 전역 저장소 (PART2에서 반드시 먼저 선언돼야 함)
const markers = [];
const markerByName = {};

// 분류별 CSS 매핑
const typeToClass = {
  tree:'tree', conifer:'conifer', shrub:'shrub', flower:'flower',
  herb:'herb', grass:'grass', vine:'vine', insect:'insect',
  spider:'spider', animal:'animal'
};

// 31종 데이터 시작
const items = [
  {
    name:'은행나무', type:'tree', emoji:'🌳',
    lng:127.01648751953951, lat:37.48950022789272,
    img:'images/은행나무.jpg',
    desc:'은행나무(Ginkgo biloba)는 현존하는 가장 오래된 계통의 나무로, 공해·한랭·병해에 강한 내성이 특징인 낙엽 교목이다. 잎은 부채 모양으로 엽맥이 방사상으로 퍼지며, 가을이면 선명한 황색 단풍이 들어 경관 가치가 크다. 암수딴그루이며 종자는 외종피 냄새가 강하나 조류의 먹이가 되기도 한다. 도심 미세먼지 저감과 그늘 제공 등 생태계 서비스 면에서 중요하다.',
    tags:['고생대계통','내공해성','가을단풍']
  },

  {
    name:'회양목', type:'shrub', emoji:'🌿',
    lng:127.01635871534069, lat:37.48975523159393,
    img:'images/회양목.jpg',
    desc:'회양목(Buxus microphylla)은 상록 관목으로 잎이 작고 밀생해 생울타리로 널리 쓰인다. 내음성·전정 적응성이 높고 도시 환경 스트레스에도 비교적 강하다. 배수 양호한 약산성 토양에서 생육이 안정적이며, 뿌리계가 조밀해 토양 고정에도 기여한다.',
    tags:['상록관목','전정적응','도시적응']
  },

  {
    name:'나팔꽃', type:'vine', emoji:'🧵',
    lng:127.0182483915749, lat:37.48985863749586,
    img:'images/나팔꽃.jpg',
    desc:'나팔꽃(Ipomoea nil)은 한해살이 덩굴식물로, 새벽에 개화하고 오후에 지는 일주 개화 특성이 있다. 벌·나비 등 수분자에 의해 번식하며 지지물을 타고 공간을 빠르게 점유한다. 학교 화단에서 수직녹화 및 생태관찰 소재로 유용하다.',
    tags:['한해살이','수분곤충','수직녹화']
  },

  {
    name:'강아지풀', type:'grass', emoji:'🌾',
    lng:127.0182918324071, lat:37.48990172324625,
    img:'images/강아지풀.jpg',
    desc:'강아지풀(Setaria spp.)은 벼과 일년생 초본으로, 교란지 및 길가에서 빠르게 군락을 형성한다. 종자는 조류와 소형 포유류의 먹이 자원이 되며, 바람에 흔들리는 수상화는 가을 자연 관찰 소재로 활용된다.',
    tags:['벼과','교란지','먹이자원']
  },

  {
    name:'향나무', type:'conifer', emoji:'🌲',
    lng:127.01618495200916, lat:37.489376075394375,
    img:'images/향나무.jpg',
    desc:'향나무(Juniperus chinensis)는 내건성·내염성·내공해성이 높아 도심 조경에 널리 쓰인다. 피톤치드 방출로 치유경관에 기여하며, 작은 구과는 조류의 먹이가 되기도 한다. 배수가 양호한 토양에서 생장 안정성이 크다.',
    tags:['상록침엽','피톤치드','내공해성']
  },

  {
    name:'무궁화', type:'flower', emoji:'🌸',
    lng:127.01656505929736, lat:37.489574270920414,
    img:'images/무궁화.jpg',
    desc:'무궁화(Hibiscus syriacus)는 여름~가을 연속 개화하는 낙엽 관목이다. 풍부한 화분과 꿀로 수분곤충 자원을 제공하며, 내서·내열성이 높아 도심에서도 안정적이다. 국가 상징 식물로서 교육적 의미도 지닌다.',
    tags:['장기개화','수분곤충','교육소재']
  },

  {
    name:'꽃댕강나무', type:'shrub', emoji:'🌿',
    lng:127.01587000596987, lat:37.48922958271119,
    img:'images/꽃댕강나무.jpg',
    desc:'꽃댕강나무(Euonymus alatus)는 줄기 코르크질 날개가 특징인 낙엽 관목이다. 가을 붉은 단풍과 종자 확산을 통해 경관 및 생태적 기능을 갖는다. 전정과 토양 적응성이 높다.',
    tags:['낙엽관목','가을단풍','조류확산']
  },

  {
    name:'등나무', type:'vine', emoji:'🧵',
    lng:127.01542473743132, lat:37.48941054421918,
    img:'images/등나무.jpg',
    desc:'등나무(Wisteria floribunda)는 봄철 포도송이형 화서를 아래로 늘어뜨리는 덩굴성 목본이다. 생장력이 강해 견고한 지지대가 필요하며, 벌·나비의 활발한 수분 자원 시기와 겹친다.',
    tags:['덩굴성','봄꽃','전정필수']
  },

  {
    name:'낙상홍', type:'shrub', emoji:'🌿',
    lng:127.0158917263866, lat:37.49052215529494,
    img:'images/낙상홍.jpg',
    desc:'낙상홍(Loropetalum spp.)은 상록 또는 반상록 관목으로 신초 적자색과 잎색 대비가 시각적 포인트를 준다. 약산성·배수양호 토양에서 엽색 표현이 우수하다.',
    tags:['상록관목','엽색미','약산성']
  },
    { name:'눈주목나무', type:'conifer', emoji:'🌲', lng:127.01525097409979, lat:37.489660442724315,
      img:'images/눈주목 나무.jpg',
      desc:'눈주목(Taxus cuspidata var.)은 주목의 왜성·관목형 재배품으로 상록 침엽수다. 내음성이 높아 그늘에서도 생육이 가능하며, 전정 반응이 양호하여 형태 유지가 쉽다. 배수 양호한 토양에서 뿌리 활력과 잎 광택이 유지된다. 대부분 조직에 독성이 존재하므로 식용·접촉에 주의가 필요하다.',
      tags:['상록침엽','내음성','독성주의'] },

    { name:'스트로브 잣나무', type:'conifer', emoji:'🌲', lng:127.01584828555309, lat:37.490651411323284,
      img:'images/스트로브 잣나무.jpg',
      desc:'스트로브 잣나무(Pinus strobus)는 북미 원산 침엽 교목으로, 침엽이 5개씩 속생하는 특징을 지닌다. 생장이 빠르고 직립 수형이 안정적이며, 양지·배수 양호한 토양에서 건실하게 자란다. 도심 공해에 대한 저항성이 비교적 높고, 조경수로서 바람길 형성 및 경관 축 구성에 적합하다. 어린 수목에서는 내풍성 확보를 위한 지지대 설치가 유용할 수 있다.',
      tags:['외래침엽','빠른생장','양지선호'] },

    { name:'미국흰불나방', type:'insect', emoji:'🐛', lng:127.01555505993065, lat:37.48986725464802,
      img:'images/미국흰불나방.jpg',
      desc:'미국흰불나방(Hyphantria cunea)은 귀화 해충으로, 유충이 집단으로 잎을 식해하여 수목 생리장해를 유발할 수 있다. 성충은 야행성이며 교미·산란 후 짧은 생활사를 거친다. 친환경 방제로는 알·유충기 조기 제거, 유인트랩 설치, 천적 보전 등이 권장된다. 교정 내 관찰·모니터링은 식생 건강성 유지에 중요하다.',
      tags:['외래해충','야행성','방제관리'] },

    { name:'배롱나무', type:'tree', emoji:'🌳', lng:127.01585457314383, lat:37.489833924282536,
      img:'images/배롱나무.jpg',
      desc:'배롱나무(Lagerstroemia indica)는 여름철 장기간 개화하는 낙엽 소교목으로, 매끈한 수피와 다채로운 화색이 관상적 가치를 높인다. 고온기 광합성 효율이 높으며, 배수 양호한 양지에서 생육이 탁월하다. 내염성·내건성은 중간 수준으로, 건기에는 관수가 유리하다. 도시열섬 완화와 경관 축 형성에 기여한다.',
      tags:['여름개화','장기개화','경관수'] },

    { name:'대왕참나무', type:'tree', emoji:'🌳', lng:127.01560736007082, lat:37.48994983338444,
      img:'images/대왕참나무.jpg',
      desc:'대왕참나무(Quercus mongolica var. grosseserrata)는 대형 낙엽 교목으로, 도토리 열매는 조류와 설치류의 중요한 먹이 자원이다. 깊고 배수 좋은 토양에서 근계 발달이 양호하며, 그늘·미기상 제공을 통해 미소서식처를 창출한다. 내한성이 높고 병해충 저항성이 비교적 강하다. 산림·도시림 모두에서 생태적 기반종으로 기능한다.',
      tags:['참나무류','먹이자원','서식처'] },

    { name:'이팝나무', type:'tree', emoji:'🌳', lng:127.01584333618712, lat:37.49002116197302,
      img:'images/이팝나무.jpg',
      desc:'이팝나무(Chionanthus retusus)는 초여름 백색 화서가 다량 착생하여 ‘쌀밥나무’라 불린다. 양지에서 개화가 극대화되며, 배수 양호한 토양에서 수세가 안정적이다. 화서가 밀집하여 수분 곤충의 활동을 촉진한다. 도심 경관 개선과 생물다양성 지원에 기여한다.',
      tags:['초여름개화','백화수','수분자원'] },

    { name:'조팝나무', type:'shrub', emoji:'🌿', lng:127.01570006497343, lat:37.48974030526104,
      img:'images/조팝나무.jpg',
      desc:'조팝나무(Spiraea prunifolia)는 봄철 백색 소화가 가지를 따라 밀도 높게 착생하는 낙엽 관목이다. 군식 시 경관 효과가 크며, 양지에서 화량이 풍부하다. 토양 적응성이 넓은 편으로, 도로변·화단 경계에 활용된다. 개화기에는 곤충 자원 제공 효과가 있다.',
      tags:['낙엽관목','봄꽃','군식'] },

    { name:'왕벚나무', type:'tree', emoji:'🌳', lng:127.0154540057988, lat:37.489883858362916,
      img:'images/왕벚나무.jpg',
      desc:'왕벚나무(Prunus × yedoensis)는 봄철 동시개화로 장관을 이루는 낙엽 교목이다. 양지와 배수 좋은 토양에서 건실하며, 개화기는 수분 곤충 활동이 집중된다. 개화 후에는 광합성 효율이 높은 잎으로 생장량을 회복한다. 경관 축과 도시문화 행사와의 결합성이 뛰어나다.',
      tags:['벚꽃','양지','수분곤충'] },

    { name:'조릿대', type:'herb', emoji:'🪴', lng:127.01528264219132, lat:37.48985933912283,
      img:'images/조릿대.jpg',
      desc:'조릿대(Sasa spp.)는 대나무류 지피식물로, 뿌리줄기의 영양생장으로 군락을 확장한다. 반그늘과 습윤한 토양에서 생육이 양호하며, 지표 피복을 통해 토양 유실을 억제한다. 교정 내 음지 녹지의 지속성을 높이고, 소형 동물의 은신처를 제공한다. 과도한 확산은 공간 관리로 제어할 수 있다.',
      tags:['지피','토양보전','반그늘'] },

    { name:'곰솔', type:'conifer', emoji:'🌲', lng:127.01523569387808, lat:37.48998448489418,
      img:'images/곰솔.jpg',
      desc:'곰솔(Pinus thunbergii)은 내염성과 방풍 효과가 뛰어난 상록 침엽수로, 해안·도시 환경 모두에서 안정적이다. 깊은 직근과 강건한 줄기가 내풍성을 높이며, 바람길 구성과 미세기상 조절에 유리하다. 배수 양호한 토양에서 수세 유지가 쉽다. 솔방울은 조류의 먹이가 된다.',
      tags:['상록침엽','내염성','방풍림'] },

    { name:'주목나무', type:'conifer', emoji:'🌲', lng:127.01524966097253, lat:37.48973608402413,
      img:'images/주목나무.jpg',
      desc:'주목(Taxus cuspidata)은 내음성이 높은 상록 침엽수로, 다양한 전정에 잘 견딘다. 붉은 가종(씨앗 주변의 가육)은 조류에 의해 섭식·확산된다. 조직에 알칼로이드계 독성이 있으므로 섭취를 피해야 한다. 배수 좋은 토양에서 수세가 안정적이며, 그늘 경관 구성에 유용하다.',
      tags:['상록침엽','내음성','조류확산'] },

    { name:'섬잣나무', type:'conifer', emoji:'🌲', lng:127.0149322169118, lat:37.48995229921796,
      img:'images/섬잣나무.jpg',
      desc:'섬잣나무(Abies koreana var.)는 상록 침엽수로 수형이 단정하여 정원수로 적합하다. 서늘하고 배수 좋은 토양에서 생육이 안정적이며, 여름 고온·과습은 생리장해 요인이 될 수 있다. 작은 구과는 관상 가치가 있다. 도시 환경에서는 통풍과 토양 배수가 중요하다.',
      tags:['상록침엽','정원수','배수중요'] },

   { name:'고양이', type:'animal', emoji:'🐱', lng:127.01518785770463, lat:37.490300025433044,
    img:'images/고양이.jpg',
    desc:'고양이(Felis catus)는 도심 생태계에서 상위 소형 포식자로 기능하며, 설치류·곤충의 개체수를 부분적으로 조절한다. 영역성이 뚜렷하고, 먹이·은신처·수분 자원이 확보된 공간을 선호한다. 인간 활동과의 상호작용이 강해 생태계 관리 시 교육·인식 측면 고려가 필요하다. 교정에서는 야생조류와의 상호작용에 주의를 기울인다.',
    tags:['도시포식자','영역성','인간-자연상호작용'] },

  { name:'무당거미', type:'spider', emoji:'🕷️', lng:127.01524966097253, lat:37.49022423908822,
    img:'images/무당거미.jpg',
    desc:'무당거미(Argiope spp.)는 주간 활동성이 비교적 높은 대형 거미로, 원형 거미줄에 안정기(장식무늬)를 만드는 습성이 관찰된다. 비행성 곤충을 적극적으로 포식하여 해충 밀도 조절에 기여한다. 햇볕과 바람이 적절한 가장자리 서식처에서 개체가 빈번하다. 생태계에서 중간 포식자 역할을 수행한다.',
    tags:['중간포식자','해충제어','가장자리서식'] },

  { name:'서양등골나물', type:'herb', emoji:'🪴', lng:127.01537326750969, lat:37.490295567415316,
    img:'images/서양등골나물.jpg',
    desc:'서양등골나물(Ajuga reptans)은 지피효과가 우수한 여러해살이 초본으로, 반그늘과 습윤한 토양에서 군락을 형성한다. 봄~초여름 보라빛 화서가 형성되며, 수분 곤충의 활동을 촉진한다. 잎이 로제트형으로 밀생하여 잡초 억제에 기여한다. 과습·과건을 피하는 균형 잡힌 수분 관리가 필요하다.',
    tags:['지피','반그늘','잡초억제'] },

  { name:'미국쑥부쟁이', type:'herb', emoji:'🪴', lng:127.01543788001703, lat:37.49031339948604,
    img:'images/미국쑥부쟁이.jpg',
    desc:'미국쑥부쟁이(Symphyotrichum pilosum)는 늦여름~가을에 다수의 소화가 착생하는 다년생 초본이다. 양지·건조 조건에서 개화량이 증가하며, 곤충의 후기사용 자원으로 기능한다. 군식 시 꽃자원이 집중되어 생물다양성에 긍정적이다. 관리 시 과밀 군락은 간헐적 분주로 활력을 유지한다.',
    tags:['다년생','양지건조','후기자원'] },

  { name:'영산홍', type:'shrub', emoji:'🌿', lng:127.01494352465994, lat:37.49031136301812,
    img:'images/영산홍.jpg',
    desc:'영산홍(Rhododendron indicum)은 상록성 철쭉류로, 약산성·배수 양호한 토양에서 엽색과 개화 상태가 우수하다. 반그늘~양지에서 생육이 가능하며, 뿌리 과습을 피하면 관리가 쉽다. 봄철 화량이 많아 수분 곤충에 자원을 제공한다. 군식·경계·사면 녹화에 활용된다.',
    tags:['상록관목','산성토양','봄개화'] },

  { name:'사철나무', type:'shrub', emoji:'🌿', lng:127.0160114348763, lat:37.49031962975003,
    img:'images/사철나무.jpg',
    desc:'사철나무(Euonymus japonicus)는 상록 관목으로 내공해성이 높아 생울타리·경계 식재에 빈용된다. 전정 내성이 강해 형태 유지가 용이하며, 엽색의 광택이 경관에 기여한다. 건조·염해에는 보통 수준으로 관리가 요구된다. 도시 미세기후 완화와 경관 경계 형성에 유용하다.',
    tags:['상록관목','경계식재','내공해성'] },

  { name:'측백나무', type:'conifer', emoji:'🌲', lng:127.0151258507945, lat:37.49053043110234,
    img:'images/측백나무.jpg',
    desc:'측백나무(Platycladus orientalis)는 원추형 상록 침엽수로 생울타리·분리 식재에 활용된다. 토양 적응성이 넓으나 배수 양호 조건에서 수세가 안정적이다. 내건성은 중간으로, 장기간 건조 시 관수가 필요할 수 있다. 전정으로 수형 조절이 가능하다.',
    tags:['상록침엽','원추형','생울타리'] },

  { name:'모과나무', type:'tree', emoji:'🌳', lng:127.01490185011437, lat:37.49046429740851,
    img:'images/모과나무.jpg',
    desc:'모과나무(Chaenomeles sinensis)는 봄철 화서와 가을 노란 열매가 모두 관상 가치가 높은 낙엽 소교목이다. 향기 강한 열매는 약·차로 활용되어 문화적 가치가 있다. 양지·배수 양호한 토양에서 결실이 좋고, 가지에 가시가 있어 생울타리 효과도 기대된다. 병해충에는 비교적 강한 편이다.',
    tags:['열매수','봄꽃','문화자원'] },

  { name:'감나무', type:'tree', emoji:'🌳', lng:127.01549571238183, lat:37.49057176463056,
    img:'images/감나무.jpg',
    desc:'감나무(Diospyros kaki)는 가을에 당분 함량이 높은 열매를 맺는 낙엽 교목이다. 양지·온난 환경에서 결실이 안정적이며, 내한성은 중간 수준이다. 잎의 황엽과 주황색 과실의 대비가 경관적으로 뛰어나다. 교육 현장에서 식물의 개화·결실·숙성과정 관찰 소재로도 적합하다.',
    tags:['과실수','가을결실','관찰소재'] },

  { name:'느티나무', type:'tree', emoji:'🌳', lng:127.0147872451164, lat:37.49042709718026,
    img:'images/느티나무.jpg',
    desc:'느티나무(Zelkova serrata)는 토종 낙엽 교목으로, 넓은 수관과 깊은 뿌리로 도시 열환경을 완화한다. 내공해성·내한성이 높아 가로수·공원수로 적합하며, 가을 단풍이 미려하다. 굵은 가지 구조는 조류의 휴식·번식 서식처를 제공한다. 배수 양호한 양지에서 수세가 안정적이다.',
    tags:['토종교목','그늘제공','내공해성'] }
];
  // ---- 마커 저장소 (투어에서 사용) ----
  const markers = [];
  const markerByName = {};

  const typeToClass = {
    tree:'tree', conifer:'conifer', shrub:'shrub', flower:'flower',
    herb:'herb', grass:'grass', vine:'vine', insect:'insect',
    spider:'spider', animal:'animal'
  };

  // ---- 마커 + 팝업 생성 ----
  items.forEach(item => {
    const el = document.createElement('div');
    el.className = `marker ${typeToClass[item.type] || 'tree'}`;
    el.title = item.name;
    el.textContent = item.emoji || '📍';

    const imgSrc = encodeURI(item.img);
    const popupHTML = `
      <div class="popup">
        <h3>${item.name}</h3>
        <img src="${imgSrc}" alt="${item.name}">
        <div>${item.desc}</div>
        <div class="tags">${(item.tags||[]).map(t=>`<span>#${t}</span>`).join(' ')}</div>
      </div>
    `;

    const popup = new mapboxgl.Popup({
      offset: 18,
      maxWidth: "340px",
      closeButton: true,
      closeOnClick: false
    }).setHTML(popupHTML);

    const marker = new mapboxgl.Marker(el)
      .setLngLat([item.lng, item.lat])
      .setPopup(popup)
      .addTo(map);

    markers.push({ marker, item });
    markerByName[item.name] = { marker, item };
  });
// ==================== 자동투어 공통 함수 ====================

// 모든 팝업 닫기
function closeAllPopups() {
  markers.forEach(({marker}) => {
    const p = marker.getPopup && marker.getPopup();
    if (p) p.remove();
  });
}

// 한 지점으로 이동 + 팝업 자동 열기
function flyAndOpen(name, dwellMs = 5000) {
  const ref = markerByName[name];
  if (!ref) return Promise.resolve();
  const { item, marker } = ref;

  map.flyTo({
    center: [item.lng, item.lat],
    zoom: 19,
    pitch: 60,
    bearing: map.getBearing(),
    essential: true,
    duration: 2000
  });

  return new Promise(resolve => {
    setTimeout(() => {
      closeAllPopups();
      const p = marker.getPopup && marker.getPopup();
      if (p) p.addTo(map);
      setTimeout(resolve, dwellMs);
    }, 2000);
  });
}

// ==================== A 루트 (분류 순서 기반) ====================

const routeA = [
  '은행나무','대왕참나무','느티나무','곰솔','스트로브 잣나무','섬잣나무','주목나무','향나무','측백나무',
  '배롱나무','왕벚나무','감나무','모과나무','이팝나무',
  '회양목','꽃댕강나무','영산홍','사철나무','낙상홍','조팝나무',
  '강아지풀','서양등골나물','미국쑥부쟁이','조릿대',
  '나팔꽃','등나무',
  '미국흰불나방','무당거미',
  '고양이'
];

async function runRouteA() {
  tour.running = true;
  for (const name of routeA) {
    if (!tour.running) break;
    await flyAndOpen(name, 5000);
  }
  tour.running = false;
}

// ==================== B 루트 (느티나무 기준 최근접 순회) ====================

function haversine(lng1, lat1, lng2, lat2) {
  const R = 6371000;
  const toRad = d => d * Math.PI/180;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

function buildNearestRoute(startName) {
  const route = [];
  const visited = new Set();
  let current = markerByName[startName]?.item;
  if (!current) return route;

  route.push(startName);
  visited.add(startName);

  for (let k = 0; k < items.length - 1; k++) {
    let best=null, bestDist=Infinity;
    for (const it of items) {
      if (visited.has(it.name)) continue;
      const d = haversine(current.lng, current.lat, it.lng, it.lat);
      if (d < bestDist) { bestDist = d; best = it; }
    }
    if (!best) break;
    route.push(best.name);
    visited.add(best.name);
    current=best;
  }
  return route;
}

async function runRouteB() {
  const routeB = buildNearestRoute('느티나무');
  tour.running = true;
  for (const name of routeB) {
    if (!tour.running) break;
    await flyAndOpen(name, 5000);
  }
  tour.running = false;
}

// ==================== 버튼 동작 연결 ====================

const tour = { running:false };

document.getElementById('btn-tour-A').onclick = () => {
  if (!tour.running) { closeAllPopups(); runRouteA(); }
};

document.getElementById('btn-tour-B').onclick = () => {
  if (!tour.running) { closeAllPopups(); runRouteB(); }
};

document.getElementById('btn-tour-stop').onclick = () => {
  tour.running = false;
  closeAllPopups();
};
<!-- ===== 투어 버튼 UI (최종본) ===== -->
<div style="
  position:absolute;
  right:10px; top:10px;
  z-index:9999;
  display:flex; flex-direction:column;
  gap:6px;
">
  <button id="btn-tour-A"
    style="padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#ffffffd9; cursor:pointer;">
    ▶ A 루트 (생태 분류)
  </button>

  <button id="btn-tour-B"
    style="padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#ffffffd9; cursor:pointer;">
    ▶ B 루트 (위치 기반)
  </button>

  <button id="btn-tour-stop"
    style="padding:8px 12px; border-radius:8px; border:1px solid #f55; background:#fff3f3; cursor:pointer;">
    ■ 정지
  </button>
</div>

