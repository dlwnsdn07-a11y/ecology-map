<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>서울교육대학교 생태지도 · 3D</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
<style>
  *{box-sizing:border-box;}
  html,body{margin:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;}
  #map{width:100%;height:100%;}

  .marker{
    width:34px;height:34px;border-radius:50%;
    background:#fff;border:2px solid #222;display:flex;align-items:center;justify-content:center;
    font-size:20px;box-shadow:0 2px 6px rgba(0,0,0,.2);cursor:pointer;
  }
  .marker.tree{border-color:#2e7d32}
  .marker.conifer{border-color:#1b5e20}
  .marker.shrub{border-color:#558b2f}
  .marker.flower{border-color:#c2185b}
  .marker.herb{border-color:#6a1b9a}
  .marker.grass{border-color:#00796b}
  .marker.vine{border-color:#2e7d32}
  .marker.insect{border-color:#f57c00}
  .marker.spider{border-color:#6d4c41}
  .marker.animal{border-color:#455a64}

  .popup{max-width:320px;font-size:14px;line-height:1.55;}
  .popup h3{margin:0 0 6px;font-size:16px;}
  .popup img{width:100%;border-radius:8px;margin:6px 0;}
  .popup .tags span{
    display:inline-block;padding:2px 6px;border:1px solid #ddd;border-radius:999px;
    font-size:12px;margin-right:4px;margin-top:4px;background:#f7f7f7;
  }

  .legend{
    position:absolute;left:10px;top:10px;z-index:50;
    background:#fff;border:1px solid #ccc;border-radius:10px;padding:10px 12px;font-size:13px;
    box-shadow:0 2px 8px rgba(0,0,0,.15);
  }
  .legend-row{display:flex;align-items:center;gap:6px;margin:4px 0;}
  .legend .dot{
    width:20px;height:20px;border-radius:50%;border:2px solid #222;
    display:flex;align-items:center;justify-content:center;font-size:14px;
  }
  .dot.tree{border-color:#2e7d32}.dot.conifer{border-color:#1b5e20}.dot.shrub{border-color:#558b2f}
  .dot.flower{border-color:#c2185b}.dot.herb{border-color:#6a1b9a}.dot.grass{border-color:#00796b}
  .dot.vine{border-color:#2e7d32}.dot.insect{border-color:#f57c00}.dot.spider{border-color:#6d4c41}.dot.animal{border-color:#455a64}

  /* 버튼 UI */
  #tour-ui{
    position:absolute;right:10px;top:10px;z-index:9999;
    display:flex;flex-direction:column;gap:6px;
  }
  #tour-ui button{
    padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#ffffffd9;cursor:pointer;
  }
  #btn-tour-stop{background:#fff3f3;border-color:#f55;}
</style>
</head>
<body>

<div id="map"></div>

<!-- 투어 버튼 (중복 없음 / 최종본) -->
<div id="tour-ui">
  <button id="btn-tour-A">▶ A 루트 (생태 분류)</button>
  <button id="btn-tour-B">▶ B 루트 (위치 기반)</button>
  <button id="btn-tour-stop">■ 정지</button>
</div>

<!-- 범례 -->
<div class="legend">
  <div class="legend-row"><span class="dot conifer">🌲</span> 침엽수</div>
  <div class="legend-row"><span class="dot tree">🌳</span> 활엽 교목</div>
  <div class="legend-row"><span class="dot shrub">🌿</span> 관목</div>
  <div class="legend-row"><span class="dot flower">🌸</span> 꽃/화목</div>
  <div class="legend-row"><span class="dot herb">🪴</span> 초본</div>
  <div class="legend-row"><span class="dot grass">🌾</span> 잔디/벼과</div>
  <div class="legend-row"><span class="dot vine">🧵</span> 덩굴</div>
  <div class="legend-row"><span class="dot insect">🐛</span> 곤충</div>
  <div class="legend-row"><span class="dot spider">🕷️</span> 거미</div>
  <div class="legend-row"><span class="dot animal">🐱</span> 동물</div>
</div>

<script>
/* 1) 토큰 & 지도 */
mapboxgl.accessToken = 'pk.eyJ1IjoianVudXV1dSIsImEiOiJjbWg1OXI2enEwNXJiMmlyM2txdHBjNmNwIn0.HdqWmsUAAzUdtbIOmHoSvg';

const map = new mapboxgl.Map({
  container:'map',
  style:'mapbox://styles/mapbox/light-v11',
  center:[127.0160,37.4899],
  zoom:18,
  pitch:60,
  bearing:-20
});

map.on('style.load',()=>{
  const labelLayer = map.getStyle().layers.find(l=>l.type==='symbol' && l.layout?.["text-field"]);
  map.addLayer({
    id:'3d-buildings',
    source:'composite',
    'source-layer':'building',
    filter:['==','extrude','true'],
    type:'fill-extrusion',
    minzoom:15,
    paint:{
      'fill-extrusion-color':'#a7b0b5',
      'fill-extrusion-height':['interpolate',['linear'],['zoom'],15,0,15.05,['get','height']],
      'fill-extrusion-base':['interpolate',['linear'],['zoom'],15,0,15.05,['get','min_height']],
      'fill-extrusion-opacity':0.7
    }
  },labelLayer?.id);
});

map.on('click',e=>console.log('clicked:',e.lngLat));

/* 2) 전역 저장소 */
const markers = [];
const markerByName = {};

/* 3) 분류 매핑 */
const typeToClass = {
  tree:'tree', conifer:'conifer', shrub:'shrub', flower:'flower',
  herb:'herb', grass:'grass', vine:'vine', insect:'insect',
  spider:'spider', animal:'animal'
};

/* 4) 데이터 (31종) */
const items = [
  { name:'은행나무', type:'tree', emoji:'🌳', lng:127.01648751953951, lat:37.48950022789272, img:'images/은행나무.jpg',
    desc:'은행나무(Ginkgo biloba)는 공해·한랭·병해에 강한 낙엽 교목으로, 부채 모양 잎이 가을에 황색 단풍을 이룬다. 암수딴그루이며 종자는 조류의 먹이가 되기도 한다. 양지·배수 양호 토양에서 가장 건강하다.',
    tags:['고생대계통','내공해성','가을단풍'] },

  { name:'회양목', type:'shrub', emoji:'🌿', lng:127.01635871534069, lat:37.48975523159393, img:'images/회양목.jpg',
    desc:'회양목(Buxus microphylla)은 상록 관목. 내음성·전정 적응성이 높아 생울타리에 적합하고 도시 스트레스에도 강하다. 약산성·배수 양호 토양 선호.',
    tags:['상록관목','전정용이','도시적응'] },

  { name:'나팔꽃', type:'vine', emoji:'🧵', lng:127.0182483915749, lat:37.48985863749586, img:'images/나팔꽃.jpg',
    desc:'나팔꽃(Ipomoea nil)은 한해살이 덩굴. 새벽 개화·오후 낙화의 일주 습성. 지지물을 타고 빠르게 신장하며 수직녹화에 유용.',
    tags:['한해살이','수분곤충','수직녹화'] },

  { name:'강아지풀', type:'grass', emoji:'🌾', lng:127.0182918324071, lat:37.48990172324625, img:'images/강아지풀.jpg',
    desc:'강아지풀(Setaria spp.)은 벼과 일년생 초본. 교란지에서 군락 형성 빠름. 종자는 조류·소형 포유류 먹이자원.',
    tags:['벼과','교란지선호','먹이자원'] },

  { name:'향나무', type:'conifer', emoji:'🌲', lng:127.01618495200916, lat:37.489376075394375, img:'images/향나무.jpg',
    desc:'향나무(Juniperus chinensis)는 내건성·내염성·내공해성이 높은 상록 침엽. 피톤치드 방출로 치유 경관에 기여.',
    tags:['상록침엽','내공해성','피톤치드'] },

  { name:'무궁화', type:'flower', emoji:'🌸', lng:127.01656505929736, lat:37.489574270920414, img:'images/무궁화.jpg',
    desc:'무궁화(Hibiscus syriacus)는 여름~가을 장기 개화 관목. 화분·꿀이 풍부해 수분곤충 자원 제공. 내서·내열성이 높아 도시 적응 양호.',
    tags:['장기개화','수분곤충','교육소재'] },

  { name:'꽃댕강나무', type:'shrub', emoji:'🌿', lng:127.01587000596987, lat:37.48922958271119, img:'images/꽃댕강나무.jpg',
    desc:'꽃댕강나무(Euonymus alatus)는 줄기 코르크 날개와 가을 단풍이 특징인 낙엽 관목. 전정·토양 적응성 높음.',
    tags:['낙엽관목','가을단풍','조류확산'] },

  { name:'등나무', type:'vine', emoji:'🧵', lng:127.01542473743132, lat:37.48941054421918, img:'images/등나무.jpg',
    desc:'등나무(Wisteria floribunda)는 포도송이형 하수화서를 보이는 덩굴성 목본. 지지대 필요, 봄 수분곤충 자원 풍부.',
    tags:['덩굴목본','봄꽃','전정관리'] },

  { name:'낙상홍', type:'shrub', emoji:'🌿', lng:127.0158917263866, lat:37.49052215529494, img:'images/낙상홍.jpg',
    desc:'낙상홍(Loropetalum spp.)은 상록~반상록 관목. 신초 적자색 대비가 경관 포인트. 약산성·배수 양호 토양에서 엽색 선명.',
    tags:['상록관목','엽색미','약산성'] },

  { name:'눈주목나무', type:'conifer', emoji:'🌲', lng:127.01525097409979, lat:37.489660442724315, img:'images/눈주목 나무.jpg',
    desc:'눈주목(Taxus cuspidata var.)은 왜성 관목형 주목. 내음성 높고 전정 반응 좋음. 조직에 독성 성분 있어 섭취 금지.',
    tags:['상록침엽','내음성','독성주의'] },

  { name:'스트로브 잣나무', type:'conifer', emoji:'🌲', lng:127.01584828555309, lat:37.490651411323284, img:'images/스트로브 잣나무.jpg',
    desc:'스트로브 잣나무(Pinus strobus)는 북미 원산 침엽 교목. 빠른 생장, 5엽 속생. 양지·배수 양호 토양 선호.',
    tags:['외래침엽','빠른생장','양지선호'] },

  { name:'미국흰불나방', type:'insect', emoji:'🐛', lng:127.01555505993065, lat:37.48986725464802, img:'images/미국흰불나방.jpg',
    desc:'미국흰불나방(Hyphantria cunea) 유충이 잎을 식해하는 귀화 해충. 친환경 방제: 알·유충 조기 제거, 유인트랩, 천적 보전.',
    tags:['외래해충','야행성','방제관리'] },

  { name:'배롱나무', type:'tree', emoji:'🌳', lng:127.01585457314383, lat:37.489833924282536, img:'images/배롱나무.jpg',
    desc:'배롱나무(Lagerstroemia indica)는 여름 장기 개화 소교목. 수피가 매끈하고 화색 다양. 양지·배수 양호에서 우수.',
    tags:['여름개화','장기개화','경관수'] },

  { name:'대왕참나무', type:'tree', emoji:'🌳', lng:127.01560736007082, lat:37.48994983338444, img:'images/대왕참나무.jpg',
    desc:'대왕참나무(Quercus mongolica var.) 대형 낙엽 교목. 도토리는 조류·설치류 먹이. 미소서식처 제공.',
    tags:['참나무류','먹이자원','서식처'] },

  { name:'이팝나무', type:'tree', emoji:'🌳', lng:127.01584333618712, lat:37.49002116197302, img:'images/이팝나무.jpg',
    desc:'이팝나무(Chionanthus retusus)는 초여름 백화 밀집 개화(쌀밥나무). 양지에서 개화 극대화.',
    tags:['초여름개화','백화수','수분자원'] },

  { name:'조팝나무', type:'shrub', emoji:'🌿', lng:127.01570006497343, lat:37.48974030526104, img:'images/조팝나무.jpg',
    desc:'조팝나무(Spiraea prunifolia)는 봄 백색 소화 다량. 군식 시 경관 효과 큼, 토양 적응성 넓음.',
    tags:['낙엽관목','봄꽃','군식'] },

  { name:'왕벚나무', type:'tree', emoji:'🌳', lng:127.0154540057988, lat:37.489883858362916, img:'images/왕벚나무.jpg',
    desc:'왕벚나무(Prunus × yedoensis) 봄 동시개화로 장관. 개화 후 빠른 광합성 회복.',
    tags:['벚꽃','양지','수분곤충'] },

  { name:'조릿대', type:'herb', emoji:'🪴', lng:127.01528264219132, lat:37.48985933912283, img:'images/조릿대.jpg',
    desc:'조릿대(Sasa spp.)는 뿌리줄기 확장 지피 식물. 반그늘·습윤 토양 선호. 토양 유실 억제.',
    tags:['지피','토양보전','반그늘'] },

  { name:'곰솔', type:'conifer', emoji:'🌲', lng:127.01523569387808, lat:37.48998448489418, img:'images/곰솔.jpg',
    desc:'곰솔(Pinus thunbergii) 내염성·방풍 효과 탁월. 깊은 직근으로 내풍성 높음.',
    tags:['상록침엽','내염성','방풍림'] },

  { name:'주목나무', type:'conifer', emoji:'🌲', lng:127.01524966097253, lat:37.48973608402413, img:'images/주목나무.jpg',
    desc:'주목(Taxus cuspidata) 내음성 높은 상록 침엽. 전정 강함. 가종은 조류 확산. 조직 독성 주의.',
    tags:['상록침엽','내음성','조류확산'] },

  { name:'섬잣나무', type:'conifer', emoji:'🌲', lng:127.0149322169118, lat:37.48995229921796, img:'images/섬잣나무.jpg',
    desc:'섬잣나무(Abies koreana var.) 단정한 수형. 서늘·배수 양호 토양 선호, 여름 고온·과습 주의.',
    tags:['상록침엽','정원수','배수중요'] },

  { name:'고양이', type:'animal', emoji:'🐱', lng:127.01518785770463, lat:37.490300025433044, img:'images/고양이.jpg',
    desc:'고양이(Felis catus) 도심 생태계의 소형 포식자. 설치류·곤충에 영향. 야생조류와의 상호작용 관리 필요.',
    tags:['도시포식자','영역성','인간-자연상호작용'] },

  { name:'무당거미', type:'spider', emoji:'🕷️', lng:127.01524966097253, lat:37.49022423908822, img:'images/무당거미.jpg',
    desc:'무당거미(Argiope spp.) 원형 거미줄에 장식무늬(안정기). 비행성 곤충 포식으로 해충 조절에 기여.',
    tags:['중간포식자','해충제어','가장자리서식'] },

  { name:'서양등골나물', type:'herb', emoji:'🪴', lng:127.01537326750969, lat:37.490295567415316, img:'images/서양등골나물.jpg',
    desc:'서양등골나물(Ajuga reptans) 반그늘·습윤 토양 선호 지피 초본. 봄~초여름 보라 화서. 잡초 억제 도움.',
    tags:['지피','반그늘','잡초억제'] },

  { name:'미국쑥부쟁이', type:'herb', emoji:'🪴', lng:127.01543788001703, lat:37.49031339948604, img:'images/미국쑥부쟁이.jpg',
    desc:'미국쑥부쟁이(Symphyotrichum pilosum) 늦여름~가을 개화 다년생 초본. 양지·건조에서 개화량 증가.',
    tags:['다년생','양지건조','후기자원'] },

  { name:'영산홍', type:'shrub', emoji:'🌿', lng:127.01494352465994, lat:37.49031136301812, img:'images/영산홍.jpg',
    desc:'영산홍(Rhododendron indicum) 상록성 철쭉류. 약산성·배수 양호 토양에서 엽색·개화 우수.',
    tags:['상록관목','산성토양','봄개화'] },

  { name:'사철나무', type:'shrub', emoji:'🌿', lng:127.0160114348763, lat:37.49031962975003, img:'images/사철나무.jpg',
    desc:'사철나무(Euonymus japonicus) 상록 관목. 내공해성 높고 전정 강함. 경계 식재로 빈용.',
    tags:['상록관목','경계식재','내공해성'] },

  { name:'측백나무', type:'conifer', emoji:'🌲', lng:127.0151258507945, lat:37.49053043110234, img:'images/측백나무.jpg',
    desc:'측백나무(Platycladus orientalis) 원추형 상록 침엽. 생울타리·분리 식재로 활용.',
    tags:['상록침엽','원추형','생울타리'] },

  { name:'모과나무', type:'tree', emoji:'🌳', lng:127.01490185011437, lat:37.49046429740851, img:'images/모과나무.jpg',
    desc:'모과나무(Chaenomeles sinensis) 봄 꽃·가을 열매 관상가치. 향 강한 열매는 문화적 자원.',
    tags:['열매수','봄꽃','문화자원'] },

  { name:'감나무', type:'tree', emoji:'🌳', lng:127.01549571238183, lat:37.49057176463056, img:'images/감나무.jpg',
    desc:'감나무(Diospyros kaki) 가을 주황색 열매. 양지·온난 환경에서 결실 안정.',
    tags:['과실수','가을결실','관찰소재'] },

  { name:'느티나무', type:'tree', emoji:'🌳', lng:127.0147872451164, lat:37.49042709718026, img:'images/느티나무.jpg',
    desc:'느티나무(Zelkova serrata) 토종 낙엽 교목. 넓은 수관으로 그늘 제공, 내공해성 높음.',
    tags:['토종교목','그늘제공','내공해성'] }
];

/* 5) 마커 + 팝업 생성 */
items.forEach(item=>{
  const el = document.createElement('div');
  el.className = `marker ${typeToClass[item.type] || 'tree'}`;
  el.title = item.name;
  el.textContent = item.emoji || '📍';

  const popup = new mapboxgl.Popup({
    offset:18,maxWidth:"340px",closeButton:true,closeOnClick:false
  }).setHTML(`
    <div class="popup">
      <h3>${item.name}</h3>
      <img src="${encodeURI(item.img)}" alt="${item.name}">
      <div>${item.desc}</div>
      <div class="tags">${(item.tags||[]).map(t=>`<span>#${t}</span>`).join(' ')}</div>
    </div>
  `);

  const marker = new mapboxgl.Marker(el).setLngLat([item.lng,item.lat]).setPopup(popup).addTo(map);
  markers.push({marker,item});
  markerByName[item.name] = {marker,item};
});

/* 6) 자동 투어 */
function closeAllPopups(){
  markers.forEach(({marker})=>{
    const p = marker.getPopup && marker.getPopup();
    if(p) p.remove();
  });
}
function flyAndOpen(name,dwellMs=5000){
  const ref = markerByName[name];
  if(!ref) return Promise.resolve();
  const {item,marker} = ref;
  map.flyTo({center:[item.lng,item.lat],zoom:19,pitch:60,bearing:map.getBearing(),duration:2000,essential:true});
  return new Promise(res=>{
    setTimeout(()=>{ closeAllPopups(); const p=marker.getPopup&&marker.getPopup(); if(p) p.addTo(map); setTimeout(res,dwellMs); },2000);
  });
}
function haversine(lng1,lat1,lng2,lat2){
  const R=6371000,toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function buildNearestRoute(startName){
  const route=[],vis=new Set();
  let cur=markerByName[startName]?.item; if(!cur) return route;
  route.push(startName); vis.add(startName);
  for(let k=0;k<items.length-1;k++){
    let best=null,bestD=Infinity;
    for(const it of items){
      if(vis.has(it.name)) continue;
      const d=haversine(cur.lng,cur.lat,it.lng,it.lat);
      if(d<bestD){bestD=d;best=it;}
    }
    if(!best) break;
    route.push(best.name); vis.add(best.name); cur=best;
  }
  return route;
}
const routeA = [
  '은행나무','대왕참나무','느티나무','곰솔','스트로브 잣나무','섬잣나무','주목나무','향나무','측백나무',
  '배롱나무','왕벚나무','감나무','모과나무','이팝나무',
  '회양목','꽃댕강나무','영산홍','사철나무','낙상홍','조팝나무',
  '강아지풀','서양등골나물','미국쑥부쟁이','조릿대',
  '나팔꽃','등나무',
  '미국흰불나방','무당거미',
  '고양이'
];
const tour={running:false};
async function runRoute(names){ tour.running=true; for(const n of names){ if(!tour.running) break; await flyAndOpen(n,5000);} tour.running=false; }

/* 7) 버튼 연결 */
document.getElementById('btn-tour-A').onclick=()=>{ if(!tour.running){ closeAllPopups(); runRoute(routeA);} };
document.getElementById('btn-tour-B').onclick=()=>{ if(!tour.running){ closeAllPopups(); runRoute(buildNearestRoute('느티나무'));} };
document.getElementById('btn-tour-stop').onclick=()=>{ tour.running=false; closeAllPopups(); };

</script>
</body>
</html>
